<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    onValue,
    update,
    remove
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

  // ğŸ” CONFIG FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyCNcjKdISg8-X8QPFPY3pAqTCfjAa3Ie1M",
    authDomain: "cfreitas-perfumary.firebaseapp.com",
    projectId: "cfreitas-perfumary",
    storageBucket: "cfreitas-perfumary.firebasestorage.app",
    messagingSenderId: "459216808781",
    appId: "1:459216808781:web:9a367e81b9d14c5c95e504"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const productsRef = ref(db, "produtos");

  // ğŸ” ADMIN
  const ADMIN_PASSWORD = "cfreitas2025";
  let isAdmin = false;
  let editingId = null;

  // ELEMENTOS
  const el = {
    loginBtn: document.getElementById("loginBtn"),
    logoutBtn: document.getElementById("logoutBtn"),
    loginModal: document.getElementById("loginModal"),
    closeLoginModal: document.getElementById("closeLoginModal"),
    passwordInput: document.getElementById("passwordInput"),
    loginSubmit: document.getElementById("loginSubmit"),
    loginError: document.getElementById("loginError"),
    adminControls: document.getElementById("adminControls"),
    addProductBtn: document.getElementById("addProductBtn"),
    productForm: document.getElementById("productForm"),
    closeForm: document.getElementById("closeForm"),
    formTitle: document.getElementById("formTitle"),
    productName: document.getElementById("productName"),
    productImage: document.getElementById("productImage"),
    saveProduct: document.getElementById("saveProduct"),
    productsGrid: document.getElementById("productsGrid"),
    emptyState: document.getElementById("emptyState")
  };

  // ğŸ” LOGIN
  function handleLogin() {
    if (el.passwordInput.value === ADMIN_PASSWORD) {
      isAdmin = true;
      el.loginModal.style.display = "none";
      el.loginBtn.style.display = "none";
      el.logoutBtn.style.display = "flex";
      el.adminControls.style.display = "flex";
      el.loginError.style.display = "none";
      renderProducts(currentProducts);
    } else {
      el.loginError.style.display = "block";
    }
    el.passwordInput.value = "";
  }

  el.loginBtn.onclick = () => el.loginModal.style.display = "flex";
  el.closeLoginModal.onclick = () => el.loginModal.style.display = "none";
  el.loginSubmit.onclick = handleLogin;

  el.logoutBtn.onclick = () => {
    isAdmin = false;
    el.loginBtn.style.display = "flex";
    el.logoutBtn.style.display = "none";
    el.adminControls.style.display = "none";
    el.productForm.style.display = "none";
    renderProducts(currentProducts);
  };

  // ğŸ“¦ PRODUTOS
  let currentProducts = [];

  onValue(productsRef, snapshot => {
    currentProducts = [];
    snapshot.forEach(child => {
      currentProducts.push({ id: child.key, ...child.val() });
    });
    renderProducts(currentProducts);
  });

  function renderProducts(products) {
    if (!products.length) {
      el.productsGrid.style.display = "none";
      el.emptyState.style.display = "block";
      return;
    }

    el.productsGrid.style.display = "grid";
    el.emptyState.style.display = "none";

    el.productsGrid.innerHTML = products.map(p => `
      <div class="relative bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl shadow-xl border-2 border-amber-200 overflow-hidden">
        <img src="${p.image}" class="w-full h-72 object-cover">
        ${isAdmin ? `
          <div class="absolute top-3 right-3 flex gap-2">
            <button onclick="editProduct('${p.id}')" class="p-3 bg-blue-500 text-white rounded-full">âœï¸</button>
            <button onclick="deleteProduct('${p.id}')" class="p-3 bg-red-500 text-white rounded-full">ğŸ—‘ï¸</button>
          </div>
        ` : ""}
        <div class="p-6 text-center">
          <h3 class="text-2xl font-display font-bold text-amber-900">${p.name}</h3>
        </div>
      </div>
    `).join("");
  }

  // â• SALVAR
  el.saveProduct.onclick = async () => {
    if (!el.productName.value || !el.productImage.value) return;

    if (editingId) {
      await update(ref(db, "produtos/" + editingId), {
        name: el.productName.value,
        image: el.productImage.value
      });
    } else {
      await push(productsRef, {
        name: el.productName.value,
        image: el.productImage.value
      });
    }

    el.productForm.style.display = "none";
    editingId = null;
    el.productName.value = "";
    el.productImage.value = "";
  };

  window.editProduct = id => {
    const p = currentProducts.find(x => x.id === id);
    if (!p) return;
    editingId = id;
    el.productName.value = p.name;
    el.productImage.value = p.image;
    el.productForm.style.display = "block";
  };

  window.deleteProduct = async id => {
    if (confirm("Excluir produto?")) {
      await remove(ref(db, "produtos/" + id));
    }
  };

  el.addProductBtn.onclick = () => {
    editingId = null;
    el.productName.value = "";
    el.productImage.value = "";
    el.productForm.style.display = "block";
  };
</script>
